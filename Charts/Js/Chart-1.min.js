import{PageElements,ChartCtrl,TrainingMessages,locStorName,ServerDataExchange,DateTime,ChartsCollection}from"../../Main/Js/Functions.js";let forChartPageData=JSON.parse(sessionStorage.getItem(locStorName(ChartsCollection.FOR_CHART_PAGE_STORAGENAME))),ChartType="line",chartCanvas=document.getElementById("Chart").getContext("2d");export let Chart=new ChartCtrl(chartCanvas,ChartType,forChartPageData.idPath);export let chartContainer=document.querySelector("#ChartContainer");chartContainer.style.backgroundColor=Chart.getOptionsProp("background");let loadDataToChart=function(e,t,a){let r=document.querySelector(".loader");r.classList.add("visible");let n=ServerDataExchange.GetChartData(forChartPageData.idPath,{type:e,firstValue:t,secondValue:a});Chart.rebuildTrends(n),r.classList.remove("visible")},DFSstartVal=Chart.getMinTime(),DFSecondVal=Chart.getMaxTime(),DFSType=2;loadDataToChart(DFSType,DFSstartVal,DFSecondVal);let meterSettings_pageItem=document.querySelector("#meterSettings");meterSettings_pageItem.addEventListener("click",()=>{let e=window.parent.document,t=e.querySelector(".workspace-iframe");t.style.height=`${document.body.offsetHeight+50}px`});let meterSettingsWrap=document.querySelector("#meterSettingsWrap"),MeterSetting=new PageElements.MeterSettingsContent(meterSettingsWrap),meterSettingsData=ServerDataExchange.getMeterSettings(forChartPageData.idPath);MeterSetting.mSArea1.input_meter_path.value=forChartPageData.path,MeterSetting.mSArea1.input_meter_name.value=forChartPageData.name;for(let e=0;e<4;e++)MeterSetting.mSArea2.input_ip[e].value=meterSettingsData.ip[e];MeterSetting.mSArea2.select_rs_type.value=meterSettingsData.rs_type,MeterSetting.mSArea2.input_rs_port.value=meterSettingsData.rs_port,MeterSetting.mSArea2.input_rs485_adress.value=meterSettingsData.rs485_adress,MeterSetting.mSArea3.subArea1.column1.cbList.setUnchecked(0);let i=0;for(let e of MeterSetting.mSArea3.subArea1.column1.cbLinesContent)e.parNameInput.value=meterSettingsData.dataExchange[i].label,e.parObisCodeInput.value=meterSettingsData.dataExchange[i].obisCode,MeterSetting.mSArea3.subArea1.column1.cbList.checkBoxes[i].checked=meterSettingsData.dataExchange[i].active,i++;for(let e of MeterSetting.mSArea3.subArea1.column2.cbLinesContent)e.parNameInput.value=meterSettingsData.dataExchange[i].label,e.parObisCodeInput.value=meterSettingsData.dataExchange[i].obisCode,MeterSetting.mSArea3.subArea1.column2.cbList.checkBoxes[i-13].checked=meterSettingsData.dataExchange[i].active,i++;MeterSetting.mSArea3.subArea2.column1.input_metter_timeValue.value=meterSettingsData.exchangeTimeValue,MeterSetting.mSArea3.subArea2.column3.select.value=meterSettingsData.exchangeTimeType,MeterSetting.applyButton.addEventListener("click",()=>{let e={ip:[]};for(let t=0;t<4;t++)e.ip[t]=MeterSetting.mSArea2.input_ip[t].value;e.rs_type=MeterSetting.mSArea2.select_rs_type.value,e.rs_port=MeterSetting.mSArea2.input_rs_port.value,e.rs485_adress=MeterSetting.mSArea2.input_rs485_adress.value,e.dataExchange=[];let t=0;for(let a of MeterSetting.mSArea3.subArea1.column1.cbLinesContent){let r={name:`de${t}`,active:MeterSetting.mSArea3.subArea1.column1.cbList.checkBoxes[t].checked,label:a.parNameInput.value||a.parNameInput.placeholder,obisCode:a.parObisCodeInput.value||a.parObisCodeInput.placeholder};e.dataExchange.push(r),t++}for(let a of MeterSetting.mSArea3.subArea1.column2.cbLinesContent){let r={name:`de${t}`,active:MeterSetting.mSArea3.subArea1.column2.cbList.checkBoxes[t-13].checked,label:a.parNameInput.value||a.parNameInput.placeholder,obisCode:a.parObisCodeInput.value||a.parObisCodeInput.placeholder};e.dataExchange.push(r),t++}e.exchangeTimeValue=MeterSetting.mSArea3.subArea2.column1.input_metter_timeValue.value,e.exchangeTimeType=MeterSetting.mSArea3.subArea2.column3.select.value,ServerDataExchange.setMeterSettings({idPath:forChartPageData.idPath,meterSettings:e})});let meterSettings_checkbox=document.querySelector("#meterSettings_checkbox"),meterSettingsHidden=!0,TrainingMessagesMS=new TrainingMessages("meterSettings",[{target:MeterSetting.mSArea3.subArea1.column1.cbList.checkBoxes[0],text:"установите, или отмените опрос счетчика. При выключенном опросе значения будут равнятся нулю"},{target:MeterSetting.mSArea3.subArea2.column1.input_metter_timeValue,text:"данные настройки позволяют изменить период опроса счетчика"},{target:MeterSetting.applyButton,text:'чтобы изменения вступили в силу нажмите "Применить"'}]);TrainingMessagesMS.hide(),meterSettings_checkbox.addEventListener("click",()=>{meterSettingsHidden=!meterSettingsHidden,meterSettingsHidden?TrainingMessagesMS.hide():TrainingMessagesMS.show()});let CTBB_SelectTrend=document.querySelector("#CTBB_SelectTrend"),SelectTrendPopUp=new PageElements.PopUp(document.body,CTBB_SelectTrend),parameterCBList=PageElements.CreateCheckBoxList(SelectTrendPopUp.body,"parameterCBList",Chart.cData.datasets.length);i=0;for(let e of Chart.cData.datasets)parameterCBList.cbLabels[i].innerText=e.label,e.hidden?parameterCBList.setUnchecked(i):parameterCBList.setChecked(i),parameterCBList.checkBoxes[i].addEventListener("click",()=>{let e=0;for(let t of Chart.cData.datasets){let a=document.querySelector(`#parameterCBList_item_${e}`);Chart.setDatasetProp(t.Name,`hidden=${!a.checked}`),e++}}),i++;let OpenSettingsPopUp=document.querySelector("#CTBB_Settings"),ChartSettingsPopUp=new PageElements.PopUp(document.body,OpenSettingsPopUp);ChartSettingsPopUp.body.appendChild(document.querySelector(".pop_up_body_tabs"));let tabs=document.querySelectorAll(".tab"),CStabItems=document.querySelectorAll(".tab_item.cs");tabs.forEach(e=>{e.addEventListener("click",()=>{let t=e,a=t.getAttribute("tab-data"),r=document.querySelector(a);t.classList.contains("active")||(tabs.forEach(e=>{e.classList.remove("active")}),CStabItems.forEach(e=>{e.classList.remove("active")}),t.classList.add("active"),r.classList.add("active"))})});for(let e of CStabItems)ChartSettingsPopUp.body.appendChild(e);export let PopUpApply=document.querySelector(".pop_up_apply");ChartSettingsPopUp.body.appendChild(PopUpApply),tabs[0].click();let TrainingMessagesTS=new TrainingMessages("trendSettings",[{target:tabs[0],text:"Чтобы переключатся между группами настройки нажимайте соответствующие вкладки"},{target:PopUpApply,text:"Чтобы изменения вступили в силу нажмите данную кнопку. <br>Важно! Изменения применятся со всех вкладок"}]);TrainingMessagesTS.hide();let CSPopUpCtrlVisibility=()=>{ChartSettingsPopUp.main.addEventListener("transitionend",()=>{ChartSettingsPopUp.displayed?TrainingMessagesTS.show():TrainingMessagesTS.hide()})};ChartSettingsPopUp.calllButton.addEventListener("click",()=>{CSPopUpCtrlVisibility()}),ChartSettingsPopUp.closeButton.addEventListener("click",()=>{CSPopUpCtrlVisibility()}),PopUpApply.addEventListener("click",()=>{CSPopUpCtrlVisibility()});let CTBB_Online=document.querySelector("#CTBB_Online");CTBB_Online.addEventListener("click",()=>{CTBB_Online.classList.contains("active")?CTBB_Online.classList.remove("active"):CTBB_Online.classList.add("active"),Chart.pauseMode=!Chart.pauseMode});let serverReqInterval=setInterval(()=>{let e=new Date,t=e.setSeconds(e.getSeconds()-2),a=DateTime.DateToDCS(new Date(t)),r=[2,1e3],n=ServerDataExchange.GetChartData(forChartPageData.idPath,{type:"1",firstValue:a,secondValue:r});Chart.updateTrends(n)},2e3),OpenTimeRangePopUp=document.querySelector("#CTBB_TimeRange"),ChartTimeRangePopUp=new PageElements.PopUp(document.body,OpenTimeRangePopUp),TimeRangeArea=PageElements.CreateTimeRangeSettings(ChartTimeRangePopUp.body,"timeRangeArea");TimeRangeArea.TimeRangeSelectorOptions[2].disabled=!0;let TimeRangeApply=document.querySelector("#TimeRangeApply");ChartTimeRangePopUp.body.appendChild(TimeRangeApply),TimeRangeApply.addEventListener("click",()=>{let e,t=TimeRangeArea.startTimeInput.value,a=TimeRangeArea.timeRangeSelector.value;switch(a){case"1":e=[TimeRangeArea.timeRangeInput.value,TimeRangeArea.timeRangeItemSelect.value];break;case"2":e=TimeRangeArea.endTimeInput.value}loadDataToChart(a,t,e)});let TrainingMessagesC=new TrainingMessages("chart",[{target:document.querySelector("#meterSettings"),text:"нажмите, чтоб раскрыть меню настройки текущего счетчика"},{target:CTBB_Online,text:"нажмите, чтоб включить/выключить автопрокрутку графика при появлении новых данных"},{target:document.getElementById("Chart"),text:"колесом мыши возможно изменение масштаба"},{target:document.getElementById("Chart"),text:"движение мыши с ее зажатой кнопкой позволяет перемещатся вдоль осей"},{target:OpenSettingsPopUp,text:"нажмите, чтобы настроить общий вид графика<br>фон, цвета трендов, оси и пр."}]);